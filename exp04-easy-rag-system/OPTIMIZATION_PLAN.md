# RAG 系统优化计划表

## 一、当前系统状态分析（2026-01-07）

### 1.1 系统配置

| 配置项 | 当前值 | 最佳实践建议 | 状态 |
|--------|--------|-------------|------|
| **向量数据库** | ChromaDB | ChromaDB（符合） | ✅ 符合 |
| **嵌入模型** | moka-ai/m3e-base (768维) | m3e-base（符合） | ✅ 符合 |
| **生成模型** | Ollama qwen3:8b | qwen3:8b（符合） | ✅ 符合 |
| **Chunk Size** | 512 字符 | 512 tokens（约512字符） | ✅ 符合 |
| **Chunk Overlap** | 50 字符 | 50-100 tokens（约50-100字符） | ✅ 符合 |
| **TOP_K** | 5 | 5-10 | ✅ 符合 |
| **距离度量** | 余弦相似度 | 余弦 | ✅ 符合 |
| **上下文长度** | 1200 字符 | 2000-4000 tokens | ⚠️ 偏小 |

### 1.2 已实现的功能

✅ **已实现**：
- 混合检索（语义+关键词）
- 重排序机制
- 查询扩展
- 结果去重
- 多跳检索
- 智能分块策略
- 改进的提示词工程
- 文档元数据增强

### 1.3 待优化的功能

⚠️ **待优化**：
- 重排模型（当前使用简单的关键词匹配，未使用 BERT reranker）
- 上下文压缩（未实现）
- 查询分类（未实现）
- HyDE（假设性文档嵌入，未实现）
- 幻觉检测（未实现）
- 评估指标（只有简单的关键词匹配）

---

## 二、优化差距分析

### 2.1 检索优化

| 功能 | 当前状态 | 最佳实践 | 差距 | 优先级 |
|------|---------|---------|------|--------|
| 混合检索 | ✅ 已实现 | ✅ 必需 | 无 | - |
| 重排序 | ⚠️ 简单关键词匹配 | ✅ BERT reranker / MonoT5 | 大 | 高 |
| 查询扩展 | ✅ 已实现 | ✅ 必需 | 无 | - |
| HyDE | ❌ 未实现 | ✅ 推荐 | 中 | 中 |
| 查询分类 | ❌ 未实现 | ✅ 推荐 | 中 | 中 |
| 语义分块 | ✅ 已实现 | ✅ 必需 | 无 | - |

### 2.2 生成优化

| 功能 | 当前状态 | 最佳实践 | 差距 | 优先级 |
|------|---------|---------|------|--------|
| 提示词工程 | ✅ 已优化 | ✅ 必需 | 无 | - |
| 上下文压缩 | ❌ 未实现 | ✅ 推荐 | 大 | 高 |
| 幻觉检测 | ❌ 未实现 | ✅ 必需 | 大 | 高 |
| 焦点模式 | ❌ 未实现 | ✅ 推荐 | 中 | 中 |
| 后处理验证 | ❌ 未实现 | ✅ 必需 | 大 | 高 |

### 2.3 评估体系

| 功能 | 当前状态 | 最佳实践 | 差距 | 优先级 |
|------|---------|---------|------|--------|
| 检索质量评估 | ⚠️ 简单关键词匹配 | ✅ Recall@k, Precision@k, MRR, nDCG | 大 | 高 |
| 生成质量评估 | ⚠️ 简单关键词匹配 | ✅ 忠实度、相关性、实体召回率 | 大 | 高 |
| 端到端评估 | ⚠️ 简单关键词匹配 | ✅ 准确性、幻觉率、引用恰当性 | 大 | 高 |
| 自动化评估 | ✅ evaluate_rag.py | ✅ 必需 | 无 | - |

---

## 三、优化计划表

### 阶段 1：评估基线（预计 1 小时）

**目标**：建立当前系统的性能基线

**任务**：
1. ✅ 运行 `evaluate_rag.py` 生成基线评估结果
2. ⬜ 记录基线指标到 `BASELINE_METRICS.md`
3. ⬜ 识别主要性能瓶颈

**时间**：2026-01-07

**成果**：
- `eval_generation.json`（基线评估结果）
- `BASELINE_METRICS.md`（基线指标文档）

---

### 阶段 2：检索优化（预计 3-4 小时）

#### 2.1 实现重排序模型（优先级：高）

**目标**：使用 BERT reranker 提升检索准确性

**任务**：
1. ⬜ 安装重排序模型（如 `sentence-transformers` 的 reranker）
2. ⬜ 实现 `reranker.py` 模块
3. ⬜ 集成到 `retrieval_optimizer.py`
4. ⬜ 测试并对比效果

**预期提升**：检索相关性 +10-15%

**时间**：2026-01-07 - 2026-01-08

**成果**：
- `reranker.py`（重排序模块）
- 更新的 `retrieval_optimizer.py`
- 重排序效果对比报告

#### 2.2 实现 HyDE（优先级：中）

**目标**：使用假设性文档嵌入提升召回率

**任务**：
1. ⬜ 实现 `hyde.py` 模块
2. ⬜ 集成到检索流程
3. ⬜ 测试并对比效果

**预期提升**：召回率 +5-10%

**时间**：2026-01-08 - 2026-01-09

**成果**：
- `hyde.py`（HyDE 模块）
- HyDE 效果对比报告

#### 2.3 实现查询分类（优先级：中）

**目标**：根据查询类型选择不同的检索策略

**任务**：
1. ⬜ 实现 `query_classifier.py` 模块
2. ⬜ 定义查询类型（事实型、概念型、操作型等）
3. ⬜ 为不同类型配置不同的检索参数
4. ⬜ 测试并对比效果

**预期提升**：整体相关性 +5-8%

**时间**：2026-01-09 - 2026-01-10

**成果**：
- `query_classifier.py`（查询分类模块）
- 查询类型配置文档
- 分类效果对比报告

---

### 阶段 3：生成优化（预计 3-4 小时）

#### 3.1 实现上下文压缩（优先级：高）

**目标**：压缩冗余上下文，提升生成质量

**任务**：
1. ⬜ 实现 `context_compressor.py` 模块
2. ⬜ 使用 RECOMP 或 LLMLingua 等方法
3. ⬜ 集成到 `rag_core.py`
4. ⬜ 测试并对比效果

**预期提升**：生成质量 +8-12%，响应时间 -20%

**时间**：2026-01-10 - 2026-01-11

**成果**：
- `context_compressor.py`（上下文压缩模块）
- 更新的 `rag_core.py`
- 压缩效果对比报告

#### 3.2 实现幻觉检测（优先级：高）

**目标**：检测并减少生成答案中的幻觉

**任务**：
1. ⬜ 实现 `hallucination_detector.py` 模块
2. ⬜ 使用基于规则的检测（引用验证）
3. ⬜ 集成到生成流程
4. ⬜ 测试并对比效果

**预期提升**：幻觉率 -30-50%

**时间**：2026-01-11 - 2026-01-12

**成果**：
- `hallucination_detector.py`（幻觉检测模块）
- 更新的 `rag_core.py`
- 幻觉检测效果报告

#### 3.3 实现后处理验证（优先级：高）

**目标**：验证生成答案的准确性

**任务**：
1. ⬜ 实现 `post_processor.py` 模块
2. ⬜ 使用规则或模型验证答案
3. ⬜ 集成到生成流程
4. ⬜ 测试并对比效果

**预期提升**：答案准确性 +10-15%

**时间**：2026-01-12 - 2026-01-13

**成果**：
- `post_processor.py`（后处理模块）
- 更新的 `rag_core.py`
- 后处理效果报告

---

### 阶段 4：评估体系完善（预计 2-3 小时）

#### 4.1 实现完整的检索质量评估（优先级：高）

**目标**：使用标准指标评估检索质量

**任务**：
1. ⬜ 实现 Recall@k、Precision@k、Hit@k
2. ⬜ 实现 MRR、nDCG、mAP
3. ⬜ 集成到 `evaluate_rag.py`
4. ⬜ 生成详细的评估报告

**时间**：2026-01-13 - 2026-01-14

**成果**：
- 更新的 `evaluate_rag.py`
- 详细的检索质量评估报告

#### 4.2 实现生成质量评估（优先级：高）

**目标**：使用标准指标评估生成质量

**任务**：
1. ⬜ 实现忠实度评估
2. ⬜ 实现相关性评估
3. ⬜ 实现实体召回率评估
4. ⬜ 集成到 `evaluate_rag.py`
5. ⬜ 生成详细的评估报告

**时间**：2026-01-14 - 2026-01-15

**成果**：
- 更新的 `evaluate_rag.py`
- 详细的生成质量评估报告

#### 4.3 实现端到端评估（优先级：高）

**目标**：评估整个系统的端到端效果

**任务**：
1. ⬜ 实现准确性评估
2. ⬜ 实现幻觉率评估
3. ⬜ 实现引用恰当性评估
4. ⬜ 集成到 `evaluate_rag.py`
5. ⬜ 生成详细的端到端评估报告

**时间**：2026-01-15 - 2026-01-16

**成果**：
- 更新的 `evaluate_rag.py`
- 详细的端到端评估报告

---

### 阶段 5：综合测试和优化（预计 2-3 小时）

**目标**：综合测试所有优化，进行最终调优

**任务**：
1. ⬜ 运行完整的评估套件
2. ⬜ 对比优化前后的性能
3. ⬜ 调优参数
4. ⬜ 生成最终优化报告

**时间**：2026-01-16 - 2026-01-17

**成果**：
- `OPTIMIZATION_REPORT.md`（最终优化报告）
- 更新的 `eval_generation.json`
- 优化后的系统配置

---

## 四、预期成果

### 4.1 性能提升预期

| 指标 | 基线 | 目标 | 提升幅度 |
|------|------|------|---------|
| 检索相关性 | 70-75% | 85-90% | +15-20% |
| 生成质量 | 70-75% | 85-90% | +15-20% |
| 召回率 | 60-65% | 75-80% | +15-20% |
| 幻觉率 | 20-30% | 5-10% | -60-70% |
| 响应时间 | 10-15秒 | 8-12秒 | -20-30% |

### 4.2 文档成果

- ✅ `BASELINE_METRICS.md` - 基线指标文档
- ⬜ `reranker.py` - 重排序模块
- ⬜ `hyde.py` - HyDE 模块
- ⬜ `query_classifier.py` - 查询分类模块
- ⬜ `context_compressor.py` - 上下文压缩模块
- ⬜ `hallucination_detector.py` - 幻觉检测模块
- ⬜ `post_processor.py` - 后处理模块
- ⬜ `OPTIMIZATION_REPORT.md` - 最终优化报告

### 4.3 代码成果

- ⬜ 更新的 `retrieval_optimizer.py`
- ⬜ 更新的 `rag_core.py`
- ⬜ 更新的 `evaluate_rag.py`
- ⬜ 更新的 `config.py`

---

## 五、时间线

| 阶段 | 任务 | 开始时间 | 结束时间 | 预计耗时 |
|------|------|---------|---------|---------|
| 阶段 1 | 评估基线 | 2026-01-07 | 2026-01-07 | 1 小时 |
| 阶段 2.1 | 实现重排序模型 | 2026-01-07 | 2026-01-08 | 3-4 小时 |
| 阶段 2.2 | 实现 HyDE | 2026-01-08 | 2026-01-09 | 2-3 小时 |
| 阶段 2.3 | 实现查询分类 | 2026-01-09 | 2026-01-10 | 2-3 小时 |
| 阶段 3.1 | 实现上下文压缩 | 2026-01-10 | 2026-01-11 | 3-4 小时 |
| 阶段 3.2 | 实现幻觉检测 | 2026-01-11 | 2026-01-12 | 3-4 小时 |
| 阶段 3.3 | 实现后处理验证 | 2026-01-12 | 2026-01-13 | 3-4 小时 |
| 阶段 4.1 | 实现检索质量评估 | 2026-01-13 | 2026-01-14 | 2-3 小时 |
| 阶段 4.2 | 实现生成质量评估 | 2026-01-14 | 2026-01-15 | 2-3 小时 |
| 阶段 4.3 | 实现端到端评估 | 2026-01-15 | 2026-01-16 | 2-3 小时 |
| 阶段 5 | 综合测试和优化 | 2026-01-16 | 2026-01-17 | 2-3 小时 |

**总预计耗时**：25-35 小时

---

## 六、风险评估

### 6.1 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|---------|
| 重排序模型加载失败 | 中 | 高 | 使用本地模型，添加错误处理 |
| 上下文压缩效果不佳 | 中 | 中 | 尝试多种压缩方法，选择最佳方案 |
| 幻觉检测误报率高 | 中 | 中 | 调整检测阈值，结合多种方法 |
| 评估指标计算错误 | 低 | 中 | 充分测试，使用标准公式 |

### 6.2 时间风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|---------|
| 优化耗时超出预期 | 高 | 中 | 优先实现高优先级功能，低优先级可延后 |
| 调试时间过长 | 中 | 中 | 提前规划测试用例，使用单元测试 |

---

## 七、资源需求

### 7.1 硬件需求

- CPU: 4 核心以上
- 内存: 8GB 以上
- 磁盘: 10GB 可用空间

### 7.2 软件需求

- Python 3.10+
- 依赖包（见 requirements.txt）
- Ollama 服务（已运行）

### 7.3 数据需求

- 当前数据集：355 篇文档
- 无需额外数据

---

## 八、成功标准

### 8.1 性能标准

- ✅ 检索相关性 ≥ 85%
- ✅ 生成质量 ≥ 85%
- ✅ 召回率 ≥ 75%
- ✅ 幻觉率 ≤ 10%
- ✅ 响应时间 ≤ 12 秒

### 8.2 质量标准

- ✅ 所有模块都有单元测试
- ✅ 代码覆盖率 ≥ 80%
- ✅ 所有评估指标都有详细文档
- ✅ 优化报告完整且可复现

---

**创建时间**：2026-01-07
**最后更新**：2026-01-07
**版本**：v1.0