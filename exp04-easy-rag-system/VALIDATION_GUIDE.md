# RAG 系统验证方案

## 一、距离问题修复

### 问题诊断
- **期望**：余弦距离应该在 0-2 之间
- **实际**：距离在 200 左右
- **原因**：ChromaDB Collection 可能没有正确使用余弦距离

### 解决方案

需要重新创建 Collection 并使用余弦距离：

```powershell
# 1. 停止 Streamlit (Ctrl+C)

# 2. 删除旧数据库
cd D:\data-mining-and-knowledge-processing\2025-spring\exp04-easy-rag-system
Remove-Item chroma.sqlite3 -Force

# 3. 重新启动
streamlit run app.py
```

启动后，系统会自动创建新的 Collection（使用余弦距离）并重新索引数据。

---

## 二、RAG 系统验证方法

### 方法 1: 自动化性能测试

运行完整的性能测试：

```powershell
python test_rag_performance.py
```

**评估指标**：
- 检索相关性：> 70%
- 生成质量：> 70%
- 响应时间：< 15 秒

### 方法 2: 人工验证测试

#### 测试集设计

创建一个包含以下类型的测试集：

**1. 事实性问答**
- 询问文档中明确存在的事实
- 示例："吴银根的学术思想有哪些？"
- 验证：答案是否包含文档中的关键点

**2. 概念解释**
- 询问文档中定义的概念
- 示例："什么是肺络痹阻？"
- 验证：答案是否准确解释概念

**3. 治疗方法**
- 询问文档中的治疗方法
- 示例："如何治疗哮喘？"
- 验证：答案是否包含具体的治疗建议

**4. 关系询问**
- 询问文档中描述的关系
- 示例："肺肾两脏的关系是什么？"
- 验证：答案是否正确描述关系

#### 验证标准

**准确性（Accuracy）**
- 答案是否基于提供的文档？
- 答案是否包含错误信息？
- 答案是否回答了问题？

**完整性（Completeness）**
- 答案是否包含所有相关信息？
- 答案是否遗漏重要细节？
- 答案是否足够详细？

**相关性（Relevance）**
- 检索到的文档是否相关？
- 答案是否聚焦于问题？
- 是否包含无关信息？

**可读性（Readability）**
- 答案是否清晰易懂？
- 答案是否结构良好？
- 是否使用专业术语？

### 方法 3: 对比测试

#### 与原文对比

对于每个问题，检查：
1. 检索到的文档是否包含答案
2. 生成的答案是否准确反映文档内容
3. 是否有遗漏或错误

#### 与标准答案对比

如果有标准答案（专家提供），对比：
1. 相似度
2. 关键信息覆盖率
3. 错误率

### 方法 4: 用户体验测试

邀请实际用户测试：

**测试任务**
1. 使用系统回答 10 个问题
2. 评估答案的实用性
3. 评估系统的易用性
4. 提供反馈

**评估指标**
- 用户满意度（1-5分）
- 答案有用性（1-5分）
- 系统易用性（1-5分）
- 是否愿意使用（是/否）

---

## 三、验证检查清单

### 技术验证

- [ ] 所有依赖包正确安装
- [ ] 模型加载成功
- [ ] 数据库连接正常
- [ ] 数据索引完成
- [ ] 检索功能正常
- [ ] 生成功能正常
- [ ] 响应时间可接受

### 功能验证

- [ ] 能检索到相关文档
- [ ] 检索结果多样化（不同作者）
- [ ] 相似度距离合理（0-2）
- [ ] 答案基于文档内容
- [ ] 答案不包含编造信息
- [ ] 答案包含参考来源
- [ ] 答案不被截断

### 质量验证

- [ ] 检索相关性 > 70%
- [ ] 生成质量 > 70%
- [ ] 答案准确性高
- [ ] 答案完整性好
- [ ] 答案相关性强
- [ ] 答案可读性好

---

## 四、推荐测试问题

### 基础测试（验证基本功能）

1. **吴银根的学术思想有哪些？**
   - 预期：包含气血阴阳、肺肾相连、肺胃相关、肺络痹阻

2. **如何治疗哮喘？**
   - 预期：包含温补脾肾、化痰祛瘀等方法

3. **什么是肺络痹阻？**
   - 预期：解释肺络概念、病因、症状

### 进阶测试（验证检索质量）

4. **肺肾两脏的关系是什么？**
   - 预期：解释母子相生、呼吸、水液代谢

5. **脾肾阳虚如何导致哮喘？**
   - 预期：解释病理机制

6. **支气管扩张如何辨证治疗？**
   - 预期：包含辨证分型和治疗方法

### 边界测试（验证系统鲁棒性）

7. **感冒了咋办？**
   - 预期：如果文档中没有，应明确说明

8. **如何治疗癌症？**
   - 预期：如果文档中没有，应明确说明

9. **中医如何调理气血？**
   - 预期：包含相关内容

### 复杂测试（验证综合能力）

10. **吴银根治疗干咳性哮喘的方法是什么？**
    - 预期：包含滋阴降火通络等方法

11. **咳喘落和止喘胶囊的作用是什么？**
    - 预期：解释两种胶囊的组成和作用

12. **如何理解"以平为期"的治疗原则？**
    - 预期：解释动态平衡、相对平衡等概念

---

## 五、问题追踪

### 如果检索失败

**症状**：返回"找不到相关文档"

**检查**：
1. 数据库是否有数据（355个文档）
2. 查询是否过于具体
3. 尝试更通用的查询

**解决**：
- 增加TOP_K参数
- 使用更通用的关键词
- 检查数据是否包含相关内容

### 如果答案质量差

**症状**：答案不准确、不完整、编造信息

**检查**：
1. 检索到的文档是否相关
2. 上下文长度是否足够
3. 生成参数是否合适

**解决**：
- 优化检索策略
- 增加上下文长度
- 调整生成参数（temperature, top_p）

### 如果响应慢

**症状**：响应时间 > 15秒

**检查**：
1. 模型是否在内存中
2. 数据库索引是否优化
3. 网络连接是否正常

**解决**：
- 使用模型缓存
- 优化数据库索引
- 减少TOP_K参数

---

## 六、持续监控

### 定期测试

**每日**：
- 检查系统是否正常运行
- 回答几个基础问题

**每周**：
- 运行完整性能测试
- 检查响应时间
- 记录问题

**每月**：
- 全面功能测试
- 用户反馈收集
- 系统优化

### 性能基线

建立性能基线，定期对比：

| 指标 | 基线 | 当前 | 趋势 |
|------|------|------|------|
| 检索相关性 | 70% | _% | _ |
| 生成质量 | 70% | _% | _ |
| 响应时间 | 10s | _s | _ |
| 用户满意度 | 4.0 | _._ | _ |

---

## 七、问题报告格式

如果发现问题，按以下格式记录：

```
问题描述：[简短描述]

复现步骤：
1. [步骤1]
2. [步骤2]
3. [步骤3]

期望结果：[期望的结果]

实际结果：[实际的结果]

环境信息：
- Python版本：
- 模型版本：
- 数据库状态：

错误日志：
[粘贴错误日志]
```

---

## 八、成功标准

RAG 系统被认为"有用"需要满足：

### 技术标准
- ✅ 检索相关性 > 70%
- ✅ 生成质量 > 70%
- ✅ 响应时间 < 15秒
- ✅ 系统稳定性 > 95%

### 功能标准
- ✅ 能回答文档中的问题
- ✅ 答案准确且完整
- ✅ 不编造信息
- ✅ 提供参考来源

### 用户标准
- ✅ 用户满意度 > 4.0/5.0
- ✅ 答案有用性 > 4.0/5.0
- ✅ 系统易用性 > 4.0/5.0
- ✅ 愿意使用 > 80%

---

**更新日期**: 2026-01-07
**版本**: v1.0