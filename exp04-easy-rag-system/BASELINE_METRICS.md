# RAG 系统基线指标

## 一、系统信息

**记录时间**：2026-01-07

### 1.1 系统配置

| 配置项 | 值 |
|--------|-----|
| **向量数据库** | ChromaDB |
| **嵌入模型** | moka-ai/m3e-base (768维) |
| **生成模型** | Ollama qwen3:8b |
| **数据文件** | ./data/processed_data.json |
| **Collection 名称** | medical_rag_lite |
| **距离度量** | 余弦相似度 |

### 1.2 数据集信息

| 指标 | 值 |
|------|-----|
| **总文档数** | 355 篇 |
| **数据来源** | 9 位中医专家的学术经验集萃 |
| **Chunk Size** | 512 字符 |
| **Chunk Overlap** | 50 字符 |
| **文档 ID 范围** | 0-354 |

### 1.3 数据来源分布

| 作者 | 文档数量 | 占比 |
|------|---------|------|
| 唐汉钧 | ~56 篇 | 15.8% |
| 施杞 | ~56 篇 | 15.8% |
| 王大增 | ~48 篇 | 13.5% |
| 徐振晔 | ~44 篇 | 12.4% |
| 吴银根 | ~42 篇 | 11.8% |
| 徐蓉娟 | ~42 篇 | 11.8% |
| 邱佳信 | ~42 篇 | 11.8% |
| 王育群 | ~41 篇 | 11.5% |
| 邵长荣 | ~40 篇 | 11.3% |

---

## 二、检索配置

### 2.1 检索参数

| 参数 | 值 | 说明 |
|------|-----|------|
| **TOP_K** | 5 | 检索文档数量 |
| **检索策略** | 混合检索（语义+关键词） | 结合向量检索和关键词匹配 |
| **重排序** | 多维度评分 | 语义(0.6) + 关键词(0.3) + 长度(0.1) |
| **查询扩展** | 是 | 生成查询变体提升召回率 |
| **去重** | 是 | 基于内容哈希去重 |
| **多跳检索** | 是 | 迭代检索获取更全面信息 |

### 2.2 重排序权重

| 维度 | 权重 | 说明 |
|------|------|------|
| **语义相似度** | 0.6 | 向量相似度分数 |
| **关键词匹配** | 0.3 | 关键词匹配分数 |
| **文档长度** | 0.1 | 文档长度惩罚 |

---

## 三、生成配置

### 3.1 生成参数

| 参数 | 值 | 说明 |
|------|-----|------|
| **最大生成长度** | 1024 tokens | 避免回答截断 |
| **Temperature** | 0.7 | 控制生成随机性 |
| **Top_P** | 0.9 | 核采样参数 |
| **重复惩罚** | 1.1 | 避免重复生成 |
| **上下文长度** | 1200 字符 | 每个文档的最大长度 |

### 3.2 提示词模板

```
你是一位专业的中医医疗问答助手，擅长根据医疗文献回答用户问题。

【任务要求】
1. 仔细阅读以下上下文文档，理解其中的医疗知识和观点
2. 根据文档内容准确回答用户的问题
3. 如果文档中有明确的答案，请直接引用或总结
4. 如果文档中没有相关信息，请明确说明"提供的文档中没有相关信息"
5. 不要编造文档中没有的内容
6. 使用专业、准确的医学术语
7. 回答要条理清晰，结构完整

【上下文文档】
{context}

【用户问题】
{query}

【回答格式】
**回答：**
[你的答案内容]

**参考来源：**
- [文档1标题]
- [文档2标题]
```

---

## 四、已实现的功能

### 4.1 检索优化

✅ **已实现**：
- 混合检索（hybrid_search）
- 重排序机制（rerank_documents）
- 查询扩展（query_expansion）
- 结果去重（remove_duplicate_documents）
- 多跳检索（multi_hop_retrieval）
- 关键词提取（extract_keywords）
- 智能分块（smart_chunk_text）

### 4.2 生成优化

✅ **已实现**：
- 改进的提示词工程
- 增加上下文长度（1200 字符）
- 文档元数据增强（标题、来源）
- 要求包含参考来源

### 4.3 数据优化

✅ **已实现**：
- 智能分块策略（在语义边界切分）
- 重叠分块（50 字符重叠）
- 文档元数据增强
- 中医专业术语提取

---

## 五、待优化的功能

### 5.1 检索优化

⚠️ **待优化**：
- ❌ 重排序模型（当前使用简单的关键词匹配）
- ❌ HyDE（假设性文档嵌入）
- ❌ 查询分类（根据查询类型选择策略）
- ❌ 语义分块（当前使用固定长度分块）

### 5.2 生成优化

⚠️ **待优化**：
- ❌ 上下文压缩（RECOMP、LLMLingua）
- ❌ 幻觉检测（引用验证）
- ❌ 后处理验证（答案准确性验证）
- ❌ 焦点模式（提取关键信息）

### 5.3 评估体系

⚠️ **待优化**：
- ❌ Recall@k、Precision@k、Hit@k
- ❌ MRR、nDCG、mAP
- ❌ 忠实度、相关性、实体召回率
- ❌ 准确性、幻觉率、引用恰当性

---

## 六、性能基线（待测试）

### 6.1 检索质量

| 指标 | 当前值 | 目标值 | 状态 |
|------|--------|--------|------|
| **检索相关性** | 待测试 | ≥ 85% | ⏳ 待测试 |
| **召回率** | 待测试 | ≥ 75% | ⏳ 待测试 |
| **检索多样性** | 待测试 | ≥ 70% | ⏳ 待测试 |
| **检索排名质量** | 待测试 | ≥ 80% | ⏳ 待测试 |

### 6.2 生成质量

| 指标 | 当前值 | 目标值 | 状态 |
|------|--------|--------|------|
| **生成质量** | 待测试 | ≥ 85% | ⏳ 待测试 |
| **语义准确性** | 待测试 | ≥ 85% | ⏳ 待测试 |
| **专业术语匹配** | 待测试 | ≥ 80% | ⏳ 待测试 |
| **完整性** | 待测试 | ≥ 80% | ⏳ 待测试 |
| **幻觉率** | 待测试 | ≤ 10% | ⏳ 待测试 |

### 6.3 性能指标

| 指标 | 当前值 | 目标值 | 状态 |
|------|--------|--------|------|
| **系统初始化时间** | < 30 秒 | < 30 秒 | ✅ 符合 |
| **模型加载时间** | < 20 秒 | < 20 秒 | ✅ 符合 |
| **单次查询时间** | 10-15 秒 | < 12 秒 | ⏳ 待优化 |
| **数据索引时间** | < 30 秒 | < 30 秒 | ✅ 符合 |

---

## 七、测试用例

### 7.1 测试查询集

```python
TEST_QUERIES = [
    {
        "query": "吴银根的学术思想是什么？",
        "expected_keywords": ["气血阴阳", "平", "动态", "相对"],
        "description": "测试对吴银根学术思想的检索"
    },
    {
        "query": "施杞在中医外科方面有什么贡献？",
        "expected_keywords": ["中医外科", "临床", "经验"],
        "description": "测试对施杞专业领域的检索"
    },
    {
        "query": "如何治疗慢性阻塞性肺疾病？",
        "expected_keywords": ["肺病", "治疗", "辨证"],
        "description": "测试对疾病治疗方案的检索"
    },
    {
        "query": "中医调理气血的方法有哪些？",
        "expected_keywords": ["气血", "调理", "方药"],
        "description": "测试对中医调理方法的检索"
    },
    {
        "query": "肺肾两脏的关系是什么？",
        "expected_keywords": ["肺", "肾", "母子", "相生"],
        "description": "测试对脏腑关系的检索"
    },
    {
        "query": "如何理解'以平为期'的治疗原则？",
        "expected_keywords": ["平", "调和", "阴阳", "气血"],
        "description": "测试对治疗原则的理解"
    }
]
```

---

## 八、已知问题

### 8.1 已解决的问题

✅ **已解决**：
- ✅ 相似度距离显示问题（从 L2 改为余弦）
- ✅ 检索结果显示问题（添加文档 ID 和元数据）
- ✅ PowerShell 启动卡顿问题
- ✅ 嵌入模型加载失败问题
- ✅ Ollama 连接问题

### 8.2 待解决的问题

⚠️ **待解决**：
- ⚠️ 上下文长度偏小（1200 字符，建议 2000+）
- ⚠️ 缺少重排序模型
- ⚠️ 缺少幻觉检测
- ⚠️ 缺少上下文压缩
- ⚠️ 评估指标不完整

---

## 九、下一步行动

### 9.1 立即执行

1. ⏳ 运行 `evaluate_rag.py` 生成基线评估结果
2. ⏳ 记录基线性能指标
3. ⏳ 识别主要性能瓶颈

### 9.2 短期计划（本周）

1. ⬜ 实现重排序模型
2. ⬜ 实现上下文压缩
3. ⬜ 实现幻觉检测
4. ⬜ 完善评估体系

### 9.3 中期计划（本月）

1. ⬜ 实现 HyDE
2. ⬜ 实现查询分类
3. ⬜ 综合测试和调优
4. ⬜ 生成最终优化报告

---

## 十、参考文档

- `OPTIMIZATION_PLAN.md` - 优化计划表
- `RAG_VALIDATION_GUIDE.md` - RAG 有效性检测方案
- `OPTIMIZATION_SUMMARY.md` - 优化总结
- `test_rag_performance.py` - 性能测试脚本
- `evaluate_rag.py` - 评估脚本

---

**创建时间**：2026-01-07
**最后更新**：2026-01-07
**版本**：v1.0
**状态**：基线建立中